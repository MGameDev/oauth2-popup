<link rel="import" href="bower_components/polymer/polymer-element.html">

<dom-module id="OAuth2-PopUp">
  <template>
    <button on-click=_openTokenPopup>[[text]]</button>
  </template>

  <script>
    class OAuth2PopUp extends Polymer.Element {
      static get is() {
        return 'oauth2-popup';
      }

      static get properties() {
        return {
          authorizationUri: {
            type: String,
          },
          redirectUri: {
            type: String,
          },
          clientId: {
            type: String,
          },
          popUpSpecs: {
            type: String,
            value: 'width=800, height=800',
          },
          scopes: {
            type: String,
            value: 'read',
          },
          text: {
            type: String,
            value: 'Button',
          }
        };
      }

      _openTokenPopup() {
        console.info("Token Pop-up has been opened.");
        const responseType = 'token';

        const popUpWindow = window.open(
            `http://${this.authorizationUri}?response_type=${responseType}&client_id=${this.clientId}&redirect_uri=http://${this.redirectUri}&scope=${this.scopes}`, "Authorize App",
            this.popUpSpecs.toString()
        );

        const popUpInterval = window.setInterval(() => {

          console.info("Checking for Pop-up Href.");

          if (popUpWindow.closed) {
            clearInterval(popUpInterval);
            console.warn("Token Pop-up has been closed.");
            return;
          }

          const popUpWindowHref = popUpWindow.location.href;

          if (popUpWindowHref.indexOf(this.redirectUri.toString()) === -1)
            return;

          const popUpWindowUrl = new URL(popUpWindow.location);
          const paramMap = this._parseParams(popUpWindowUrl);

          this.dispatchEvent(new CustomEvent('tokenreceived', {detail: {paramMap: paramMap}}));

          popUpWindow.close();
        }, 500);
      }

      _parseParams(windowUrl) {
        const urlHash = windowUrl.hash.substr(1);
        const urlParams = urlHash.split('&');
        const paramPairs = urlParams.map((paramPair) => paramPair.split('='));
        return new Map(paramPairs);
      }

    }

    window.customElements.define(OAuth2PopUp.is, OAuth2PopUp);
  </script>
</dom-module>
